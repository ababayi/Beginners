# دوره مقدماتی آموزش سیستم عامل ROS

![تصویر معرفی سیستم عامل ربات](image.png)

سیستم عامل ربات ها (ROS)، بستری قدرتمند و سریع را برای یکپارچه سازی کدهای مربوط به هر یک از واحدهای ربات فراهم می سازد. به کمک سیستم عامل ربات ها می توانید تحت لینوکس کد مربوط به هر یک از واحدهای فوق را در یک گره (Node) بنویسید و ارتباط موثر بین این گره ها را از طریق پیام هایی (Topic) ایجاد کنید. سیستم عامل ربات ها یا همان ROS علاوه بر ایجاد یک ساختار منظم و کاربردی برای توسعه ربات ها، پکیج هایی استاندارد برای کاربردهای بینایی، کنترل و درایو، طراحی مسیر، نمایش داده ها و ... فراهم می کند. در این آموزش ما قصد داریم تا با این سیتسم عامل رباتیک آشنا شویم. مباحث این آموزش:

- آشنایی با مقدمات و چارچوب کلی سیستم عامل ربات [link] (/#آشنایی-با-مقدمات-و-چارچوب-سیستم-عامل-ربات)
- آشنایی با دستورات مهم لینوکس
- آموزش نصب ROS، ایجاد محیط کاری و ایجاد اولین پکیج
- آشنایی با نحوه ایجاد گره ها و تاپیک ها
- آشنا با سرویس ها
- آشنایی با پارامترها
- امکانات کاربردی سیستم عامل ROS
- آشنایی با فایل launch
- آشنایی با TFها
- زمان در ROS
- اجرای تحت شبکه ROS
- ارتباط Action در سیستم عامل ROS
- آشنایی با تنظیمات دینامیک
- آشنایی با محیط rviz و اجرای چند مثال کاربردی

در ادامه به برسی هر کدام از عناوین مطرح شده می پردازیم. لازم به ذکر است که در آینده آموزش ویدیویی ضبط و لینک آن به این صفحه اضافه خواهد شد. توجه شود که این آموزش در برگیرنده مطالب در مورد نسخه اول سیستم عامل رباتیک (ROS) می باشد.

## آشنایی با مقدمات و چارچوب سیستم عامل ربات

همان گونه که ذکر شد سیستم عامل ربات (ROS) یک چارچوب (Framework) برای توسعه استاندارد و سریع برنامه های رباتیکی می باشد که از مزایای اصلی این چارچوب می توان به متن باز (Open-Sourse) و حاوی پکیج و ابزارهای کاربردی بودن اشاره کرده. این پکیج در سال 2009 توسط یک استارت آپ به نام Willow Garage و توسط دو فرد به نام های Eric Berger و Keenan Wyrobek توسعه یافته است و از حدود سال 2014 به صورت متن باز منتشر شده است. لیست ورژن های مختلف این سیستم عامل را می توانید در لینک زیر مشاهده نمایید:

https://wiki.ros.org/Distributions

یکی از دلایل استفاده از سیستم عامل ربات (ROS) این است که در اکثر پروژه های رباتیک ما با چالش هایی برای درایور کردن عملگرها (Actuators) و حسگرها (Sensors) و اجرای این بخش اگر قرار باشد از صفر صورت بپذیرد، علاوه بر وقت گیر بودن، ما را باگ ها و مشکلات فراوان در مراحل بعدی روبرو می کند.سیستم عامل ربات شرایطی را برای ما فراهم می کنید تا ما صرفاً بر روی بخش منطق ربات کار کنیم و برای دو بخش حسگرها و عملگرها از پکیج های استاندارد ROS بهره ببریم. از مزایای دیگر سیستم عامل ربات می توان به سازگار بودن با زبان های مختلف (بالاخص زبان C++ , پایتون)، مناسب برای رشته های و حوزه های مختلف، بروزرسانی دائمی و جامعه کاربری بزرگ اشاره کرد. همچنین پکیج هایی که توسط ما بر چارچوب ROS ایجاد می شوند، قابلیت استفاده مجدد در کنار سایر پروژه ها (ما یا دیگران) را دارند.

![تصویر ساختار کلی ربات](image-1.png)

سیستم عامل ربات (ROS) به ما این امکان را می دهد تا یک برنامه رباتیکی را به بخش های مختلف تقسیم کنیم که هر کدام از این بخش ها یک گره (Node) می باشد. این نودها می توانند به روش های مختلف با یک دیگر مرتبط باشند:

- تاپیک ها (Topics)
- سرویس ها (Services)
- اکشن ها (Actions)

![نودها در  سیستم عامل ربات](image-2.png)

در نوع ارتباطی تاپیک، یک نود وظیفه انتشار اطلاعات را دارد که به آن Publisher می گویند و به سایر گره ها که اطلاعات را دریافت می کند، Subscriber می گویند. توجه شود که این ارتباطات مداوم است. یعنی پس اتصال این دو گره به هم اطلاعات با فرکانس خاصی به صورت مداوم رد و بدل می شود. نوع بعدی ارتباط سرویس ها می باشد. در این روش ارتباطی یک گره سرور و یک گره کلاینت داریم. در ابتدا هرگاه کلاینک به اطلاعات نیاز داشته باشد به سرور یک درخواست (Request) و سرور نیز در جواب پس از انجام پردازش هایی، اطلاعات را پاسخ (Respond) می دهد. در این روش ارتباطی در بازه زمانی که درخواست ارسال شده تا لحظه دریافت پاسخ، برنامه کلاینت متوقف باقی می ماند. روش سرویس زمانی که پردازش های سرور طولانی باشد یا ما بخواهیم در حین این زمان پردازشی انجام دهیم فاقد کاربرد می شود؛ پس برای این حالت به سراغ روش سوم می رویم که اکشن نام دارد و مشابه سرویس ها است با این تفاوت که در بین زمان ارسال درخواست و دریافت پاسخ، برنامه متوقف نمی شود.

![راه های ارتباطی گره ها](image-3.png)

این روش های ارتباطی در بخش های بعدی برسی بیشتر خواهد شد. لازم به ذکر است که برای توسعه هر نود می توان از زبان های مختلف استفاده کرد، البته API ارایه شده برای پایتون و سی پلاس پلاس استاندارد تر است.

## آشنایی با دستورات ابتدایی لینوکس

در این بخش قصد داریم تا برخی از دستورات (command) معروف سیستم عامل لینوکس را با هم مرور کنیم. این دستورات در محیط ترمنیال (Terminal) لینوکس استفاده می شود و تا حدود زیادی کار ما را در محیط لینوکس راحت می کند. در بخش زیر می توانید لیست این کامند ها را با توضیحات مربوطه مرور نمایید:

```bash
# Sending ping packets to a ip or address
$ ping [ip/address] -c [number-of-packets]

# Open Manual of a linux command
$ man [command-name]

# List the recent directory files and dirs
$ ls

# Navigate to a dir
$ cd [directory-name]

# Show the active directory address from root
$ pwd

# Create a directory
$ mkdir [dir-name]

# Create a file
$ touch [file-name]

# Open a file with editor
$ nano/gedit/code [file-name]

# Remove a file
$ rm [file-name]

# Remove a dir
$ rm -r [dir-name]
#or
$ rmdir [dir-name]

# Dir tree
$ tree # install: sudo apt-get install tree

# Copy files
$ cp [file-name] [goal-dir] [new-name]

# Move files
$ mv [file-name] [goal-dir] [new-name]

# Add Executability to a file
$ chmod +x [file-name]

# Shut down
$ poweroff

# Restart
$ reboot
```

توجه شود که در ترمینال منظور از ~ شاخه Home و منظور از / شاخه root می باشد.

## آشنایی با نحوه نصب ROS، ایجاد محیط کاری و اولین پکیج

در این بخش قصد داریم تا به نحوه نصب سیستم عامل ربات بپردازیم، سپس به نحوه ایجاد یک فضای کاری استاندارد برویم و اولین پکیج خودمان را نیز ایجاد نماییم. برای نصب ورژن Neotic سیستم عامل ROS می توانید به لینک زیر مراجعه نمایید:

http://wiki.ros.org/ROS/Installation

دستورات نصب به صورت خلاصه با کامنت در بخش زیر آورده شده است.

```bash
# Add the ros rep to apt dir
$ sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'

# Install curl
$ sudo apt install curl # if you haven't already installed curl

# load curl asc file and pass key
$ curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -

# Update the apt rep
$ sudo apt update

# Install ROS neotic
$ sudo apt install ros-noetic-desktop-full

# Add ros to Enviromental vars
$ echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc

# Source the bashrc file
$ source ~/.bashrc

```

پس از نصب ROS برای چک کردن اینکه آیا موفق می توانید کامند زیر هسته ROS را اجرا می نماید تست کنید:

```bash
$ roscore
```

همچنین با کامند زیر می توانید به محل نصب پکیج های ROS بروید:

```bash
$ cd /opt/ros/noetic/share/
```

پکیج های موجود در دایرکتوری بالا در واقع لیست پکیج هایی هستند که به صورت پیشفرض بر روی ROS فول ورژن موجود هستند. اگر پکیجی را در این دایرکتوری قرار دهید، می توانید از آن به صورت گلوبال بدون نیاز به اضافه کردن مجدد بهره ببرید. در کل با کمک دستور زیر می توانید، لیست محل هایی که پکیج های راس ذخیره می شوند را مشاهده نمایید:

```bash
$ echo $ROS_PACKAGE_PATH
```

همچنین ROS کامندهای برای مشاهده پکیج ها و اطلاعات آنها دارد. برخی از این کامندها (در ادامه نیز در بسته به نیاز بخش مربوطه کامنت هایی ارایه خواهند شد):

- برای مشاهده محل نصب یک پکیج (برای مثال پکیج roscpp) می توانید از دستور زیر کمک بگیرید:

```bash
$ rospack find roscpp
```

- همچنین برای رفتن به محل نصب آن، می توانید از دستور زیر بهره بگیرد:

```bash
$ roscd roscpp
```

- همچنین برای مشاهده محتویات یک پکیج می توانید از دستور زیر بهره ببرید:

```bash
$ rosls roscpp
```

همچنین با قرار دادن help جلوی سه کامند ذکر شده می توانید، با عملکرد بیشتر این پکیج ها آشنا شوید.
(از سوئیچر -h نیز می توان استفاده کرد.)

اکنون که ROS را با موفقیت نصب کردیم به سراغ ایجاد یک فضای کاری می رویم. فضای کار مجازی یا Virtual environment یک محیط استاندارد است که فایل کدهای خود را در داخل آن قرار می دهیم. برای ایجاد این محیط ابتدا یک پوشه به نام catkin_ws ایجاد کرده و همچنین در داخل آن یک دایرکتوری خالی به نام src ایجاد می کنیم. سپس کامند زیر را اجرا می کنیم تا کامپایلر ROS این محیط را برای ایجاد کند.

```bash
$ catkin_make
```

محیط کاری ما با موفقیت ایجاد شده. لازم به ذکر است در مراحل بعدی هرگاه نیاز شد مجدد برنامه را کامپایل کنیم، حتما به شاخه اصلی catkin_ws آمده و کامند بالا را اجرا کنید.

اکنون که محیط کاری مجازی را آماده کردیم، می توانیم به سراغ ایجاد اولین پکیج خود برویم. برای ایجاد پکیج کافی است به داخل پوشه src محیط کاری کتکین خود برویم و با کمک فرمت دستوری زیر یک پکیج ایجاد کنیم:

```bash
$ cd ~/catkin_ws/src
$ catkin_create_pkg <package_name> [depend1] [depend2] [depend3]
```

برای مثال:

```bash
$ catkin_create_pkg beginner_tuts std_msgs rospy roscpp
```

بعد مجدد به پوشه catkin_ws مراجعه شود و مجدد با دستور catkin_make کامپایل انجام شود. و همچنین دستور را در فایل bashrc قرار دهیم. (توجه شود که اگر در دایرکتوری هوم، ورک اسپیس را ایجاد نکرده اید آدرس زیر را اصلاح کنید!)

```bash
$ source ~/catkin_ws/devel/setup.bash
```

همچنین برای مشاهده پیش نیازها و dependencies های یک پکیج می توانید از دستور زیر کمک بگیرید (دستور زیر فقط پیش نیازهای مرحله اول را نمایش می دهد):

```bash
$ rospack denpend1 [package-name]
```

در صورتیکه بخواهید تمام پیش نیاز ها را ببینید از دستور زیر بهره بگیرید:

```bash
$ rospack denpend [package-name]
```

نکته: در فایل package.xml اطلاعات پکیج، ورژن، پیشنیاز ها و سایر اطلاعات نمایش داده می شود.

نکته: در فایل CMakeLists.txt مربوط به تنظمیات کامپایلر می باشد که لیست پکیج های پیشنیاز، پیام ها، سرویس ها، اکشن ها، اطلاعات کامپایل و ... قرار گرفته است و معمولا اگر قرار باشد یک نود با سی پلاس پلاس نوشته شود، با این فایل بسیار کار می شود.

برای دریافت اطلاعات بیشتر به صفحه خود داکیومنت راس به آدرس زیر مراجعه شود:

http://wiki.ros.org/ROS/Tutorials/CreatingPackage

## آشنایی با نحوه ایجاد گره ها و تاپیک ها

در این قسمت قصد داریم تا در مورد نحوه ایجاد گره ها (Nodes) و نحوه ایجاد تاپیک (Topics) توضیحاتی را ارایه کنیم. در ابتدا قبل ایجاد یک گره و تاپیک، چند گره معروف در ROS را اجرا میکنم. در این سیستم عامل یک پکیج با نام turtlesim وجود دارد که برای تست کردن دستورات ROS مورد استفاده قرار می گیرد. برای اجرای هر برنامه ROS نیاز است تا ابتدای کار هسته آن اجرا شود. هسته همانگونه که زودتر بیان شد با کامند زیر اجرا می شود:

```bash
$ roscore
```

برای اجرای نودها نیز از کامند زیر بهره می بریم:

```bash
$ rosrun [package-name] [node-name]
```

برای مثال برنامه لاکپشت را اجرا می کنیم، این برنامه به دو نود turtlesim_node و turtle_teleop_key را اجرا نماییم:

```bash
$ roscore
$ rosrun turtlesim turtlesim_node
$ rosrun turtlesim turtle_teleop_key
```

خروجی این برنامه به شکل زیر خواهد بود. با تغییر دکمه های موس در ترمینال مربوط به turtle_teleop_key لاکپشت شروع به حرکت می کند.

![Alt text](image-4.png)

در ادامه به برسی برخی از دستورات کاربردی در مورد گره ها و تاپیک ها می پردازیم. شما می توانید با تکرار این دستورها با برنامه turtle این دستورات را تمرین نمایید:

برای مشاهده اطلاعات یک نود از دستور زیر استفاده کنید:

```bash
$ rosnode info /rosout
```

ّبرای اجرای یک نود از یک پکیج از دستور زیر استفاده نمایید:

```bash
$ rosrun [package-name] [node-name]
```

ّتوجه شود که نودهای داخل راس تحت شبکه اجرا می شود، برای پینگ گرفتن از یک نود از دستور زیر می توان بهره برد:

```bash
$ rosnode ping /rosout
```

برای مشاهده گراف نودها می توانید از دستور زیر بهره ببرید:

```bash
$ rosrun rqt_graph rqt_graph
```

یا دستور زیر را به صورت خلاصه وارد کنید (از نئوتیک ب بعد):

```bash
$ rqt_graph
```

برای مشاهده اطلاعات یک تاپیک می توانید از دستور rostopic بهره ببرید، برای اطلاع کامل از این دستور کامند زیر را وارد نمایید تا help آنرا مشاهده نمایید:

```bash
$ rostopic -h
```

برای مثال با کمک دستور زیر می توانید لیست تاپیک ها را ببیند:

```bash
$ rostopic list
```

با کمک دستور زیر می توانید پیام های رد و بدل شده در یک تاپیک را مشاهده کنید:

```bash
$ rostopic echo /topic-name
```

با کمک دستور زیر می توانید نوع تاپیک را مشاهده نمایید:

```bash
$ rostopic type /topic-name
```

برای پابلیش کردن دیتا در یک تاپیک می توانید از دستور rostopic pub این کار را انجام دهید، البته قبل از آن نیاز است تا ساختار تاپیک را بدانیم، با کمک دستور زیر می توانید ساختار تاپیک (نوع message) را مشاهده کنید:

```bash
$ rosmsg show [message-name]
```

و سپس با دستور زیر داخل تاپیک پیام دلخواه خود را منتشر کنید:

```bash
$ rostopic pub [topic-name] [message-type] data
```

توجه شود اگر نتوانستید نوع مسیج را تایپ کنید از کلید TAB استفاده نمایید، همچنین اگر نتوانستید ساختار دیتا را وارد نمایید، دوباره TAB را بزنید. (ویدیو را ببنید متوجه می شوید)

برای متناوب کردن دستور پاب می توانیم از سوئیچر -r بهره ببریم:

```bash
$ rostopic pub [topic-name] [message-type] data -r 3
```

برای مثال در کامند بالا گفتیم با فرکانس 3 هرتز حرکت ذکر شده را تکرار کن!

با کمک دستور زیر می توانیم فرکانس پابلیش یک پیام در یک تاپیک را مشاهده کنیم

```bash
$ rostopic hz [topic-name]
```

برای پلات کردن یک تاپیک می توانید از پنجره rqt_plot بهره ببرید:

```bash
$ rosrun rqt_plot rqt_plot
```
